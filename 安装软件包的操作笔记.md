# ZED相机开发完全配置
## 设备环境

双目相机：ZEDM；电脑：华硕TUF飞行堡垒7（i59300H GTX1650）
系统：ununtu18.04
前提条件：系统已经安装好ROS，18.04对应的版本应该是melodic。可以在终端输入以下命令查看

```bash
rosversion -d
```

## 1.安装CUDA
一般来说电脑已经安装好显卡驱动，所有大的安装包建议直接去对应的github上下载，避免gitclone，wget太慢或失败。使用ZED相机（如ZED或ZED 2）时，CUDA（Compute Unified Device Architecture）是必需的，因为ZED SDK依赖CUDA进行图像处理和深度计算。因此，在安装ZED SDK之前，需要先安装CUDA。
前往[NVIDIA CUDA Toolkit]([CUDA Toolkit 11.7 Update 1 Downloads | NVIDIA Developer](https://developer.nvidia.com/cuda-11-7-1-download-archive?target_os=Linux&target_arch=x86_64&Distribution=Ubuntu&target_version=18.04&target_type=deb_local))下载页面下载适用于Ubuntu的CUDA安装包。这里CUDA的版本应该是和SDK对应，本次选取的ZED SDK版本需要使用CUDA11.7。

![image-20240716212749979](安装软件包的操作笔记.assets/image-20240716212749979.png)

按照网页的说明安装即可，对于wget命令，直接去对应的网站下载即可

```bash
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/cuda-ubuntu1804.pin
sudo mv cuda-ubuntu1804.pin /etc/apt/preferences.d/cuda-repository-pin-600
wget https://developer.download.nvidia.com/compute/cuda/11.7.1/local_installers/cuda-repo-ubuntu1804-11-7-local_11.7.1-515.65.01-1_amd64.deb
sudo dpkg -i cuda-repo-ubuntu1804-11-7-local_11.7.1-515.65.01-1_amd64.deb #安装CUDA仓库包
sudo cp /var/cuda-repo-ubuntu1804-11-7-local/cuda-*-keyring.gpg /usr/share/keyrings/ #添加GPG密钥
sudo apt-get update #更新包列表并安装CUDA
sudo apt-get -y install cuda
```

安装好之后添加对应的环境变量，修改主目录的。./bashrc文件

```bash
echo 'export PATH=/usr/local/cuda/bin:$PATH' >> ~/.bashrc
echo 'export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH' >> ~/.bashrc
source ~/.bashrc
```

使用下面命令确认安装成功：

```bash
nvcc --version #查看cuda版本，使用 nvcc -V 也行
nvidia-smi #查看你GPU的计算能力
```

![c142c7b7e3b1361ad0723ce5efb2b1a](安装软件包的操作笔记.assets/c142c7b7e3b1361ad0723ce5efb2b1a.jpg)

## 2.安装ZED SDK

ZED SDK的旧版本可以到[Legacy releases](https://www.stereolabs.com/developers/release/archives)找到，具体的安装步骤可以到[How to Install ZED SDK on Linux](https://www.stereolabs.com/docs/installation/linux)上找到。

本次安装选择[ZED SDK for Ubuntu 18](https://download.stereolabs.com/zedsdk/3.8/cu117/ubuntu18) 3.8.2版本。

下载完对应版本的SDK后转到下载安装程序的文件夹。

```bash
cd path/to/download/folder #改成自己的路径就行
```

如果尚未安装 `zstd`。 要先安装，后续的安装程序需要它才能运行。

```bash
sudo apt install zstd
```

使用 `chmod +x` 命令为安装程序添加执行权限。 确保将安装程序名称替换为您下载的版本。

```bash
chmod +x ZED_SDK_Ubuntu22_cuda11.8_v4.0.0.zstd.run
```

运行 ZED SDK 安装程序

```bash
./ZED_SDK_Ubuntu22_cuda11.8_v4.0.0.zstd.run
```

- 安装开始时会显示软件许可证，阅读后点击`q`。
- 在安装过程中，您可能需要回答一些关于安装依赖项、工具和示例的问题。 键入 `y` 表示是，`n` 表示否，然后点击 `Enter` 。 点击 `Enter` 选择默认选项。
安装过程还是比较漫长的，对于开发者不使用自带的一些AI内容，在安装过程中会节约很多时间。
安装结束后，重新启动系统以确保路径已更新。

安装结束后，进入本地的zed工具文件夹下，运行zed对应的API

```bash
cd /usr/local/zed/tools
```

![20d28c54d46ceae0b3afdab0d6e1902](安装软件包的操作笔记.assets/20d28c54d46ceae0b3afdab0d6e1902.jpg)

```bash
./ZED_Calibration #用于校准ZED相机。它允许用户调整相机的参数以获得更准确的深度数据和图像。
./ZED_Diagnostic #提供诊断工具，用于检查ZED相机的硬件和软件状态，确保相机工作正常。
./ZED_Depth_Viewer #用于查看和测试相机的深度感知功能。该工具可以实时显示相机捕获的深度图像。
./ZED_Explorer #综合工具，用于浏览和测试ZED相机的各种功能，包括深度感知、位置跟踪和相机参数调整。
./ZEDfu #实时的3D扫描和建模工具，允许用户使用ZED相机创建环境的3D模型
./ZED_Sensor_Viewer #该工具用于查看ZED相机的各种传感器数据，如加速度计、陀螺仪和环境光传感器数据。
./ZED_SVO_Editor # SVO文件编辑器，用于处理和编辑ZED相机录制的SVO文件（Stereo Video Object），这些文件包含相机录制的立体视频和深度信息。
```

下面分别是运行“./ZED_Explorer”、“./ZED_Depth_Viewer”和“./ZEDfu”的图像。

![a6005f2c82d49b0c3d9e654b1923c23](安装软件包的操作笔记.assets/a6005f2c82d49b0c3d9e654b1923c23.jpg)

![541b56e10898e7a135af2727ed6df9b](安装软件包的操作笔记.assets/541b56e10898e7a135af2727ed6df9b.jpg)

![b42b002fe238f35af27d86b6cebf2b9](安装软件包的操作笔记.assets/b42b002fe238f35af27d86b6cebf2b9.jpg)

## 3.安装ZED ROS Wrapper

ZED ROS Wrapper允许将ZED相机与ROS集成，便于在ROS环境中使用ZED相机。具体使用内容可以看看官网[ROS和ZED入门](https://www.stereolabs.com/docs/ros)。安装内容可以找到[zed-ros-wrapper](https://github.com/stereolabs/zed-ros-wrapper)中查看。

创建并初始化catkin工作空间：

```bash
mkdir -p ~/catkin_ws/src #创建好文件目录，catkin_ws名字不重要，但是下面必须有src
cd ~/catkin_ws/
```
ZED ROS Wrapper是一个ROS工程，遵循ROS相关的编译过程，克隆ZED ROS Wrapper并编译：
```bash
cd ~/catkin_ws/src
git clone --recursive https://github.com/stereolabs/zed-ros-wrapper.git
cd ../
rosdep install --from-paths src --ignore-src -r -y
catkin_make -DCMAKE_BUILD_TYPE=Release
source ./devel/setup.bash
```

但是我们如果不做修改，会显示需要更高的SDK版本。最简单的解决方法就是拉取老版本的zed-ros-wrapper库。

在cloneZED ROS Wrapper的GitHub仓库后，进入仓库目录并列出所有的版本标签（tags）：

```bash
cd ~/catkin_ws/src
git clone https://github.com/stereolabs/zed-ros-wrapper.git
cd zed-ros-wrapper
git tag #进入仓库目录并列出所有的版本标签（tags）
```

选择一个适合你当前ZED SDK版本的标签。这里是3.8.2，应该选择v3.8.x

![63b61e8643eae99ca2806022881062f](安装软件包的操作笔记.assets/63b61e8643eae99ca2806022881062f.jpg)

切换到该版本：

```bash
git checkout tags/v3.8.x
```

回到工作空间并安装依赖项：

```bash
cd ~/catkin_ws
rosdep install --from-paths src --ignore-src -r -y
```

 编译ZED ROS Wrapper，在工作空间目录下编译：

```bash
catkin_make
```

**注意：**`zed_interfaces`软件包已从该版本库中移除，并移至它自己的[`zed-ros-interfaces`版本库](https://github.com/stereolabs/zed-ros-interfaces)，以便在不需要安装完整软件包的远程地面站上更好地集成 ZED Wrapper。 要更新您的软件源，请遵循[新更新说明](https://github.com/stereolabs/zed-ros-wrapper#update-the-repository)。 有关更多信息，请阅读 [#750](https://github.com/stereolabs/zed-ros-wrapper/issues/750) 问题。

![image-20240716223452719](安装软件包的操作笔记.assets/image-20240716223452719.png)

找到[zed-ros-interfaces](https://github.com/stereolabs/zed-ros-interfaces)库，下载下来，替换zed-ros-wrapper中的空白文件夹。（也可以gitclone都行）

回到工作空间根目录，清理并重新编译：

```bash
cd ~/catkin_ws
catkin_make clean
catkin_make
source devel/setup.bash
```

运行 ZED 封装程序，启动 ZED 节点，对于不同的相机使用的launch文件不同。在这之前记得启动ROS。

```bash
roscore
```

ZED 摄像机：

```bash
roslaunch zed_wrapper zed.launch
```

ZED Mini 摄像机：

```bash
roslaunch zed_wrapper zedm.launch
```

[……](https://github.com/stereolabs/zed-ros-wrapper?tab=readme-ov-file)

这里我使用的是ZED MINI，运行第二条程序：![8ae07d81b5531566b14fca9560b2c9b](安装软件包的操作笔记.assets/8ae07d81b5531566b14fca9560b2c9b-17211426934881.jpg)

![f78a1bcea865ebecd923593ed7ea245](安装软件包的操作笔记.assets/f78a1bcea865ebecd923593ed7ea245.jpg)

为了解如何在 ROS 环境中使用 ZED 节点，下面是官方给的一些教程：

- [图像订阅教程](https://github.com/stereolabs/zed-ros-examples/tree/master/tutorials/zed_video_sub_tutorial/README.md)
- [深度订阅教程](https://github.com/stereolabs/zed-ros-examples/tree/master/tutorials/zed_depth_sub_tutorial/README.md)
- [跟踪订阅教程](https://github.com/stereolabs/zed-ros-examples/tree/master/tutorials/zed_tracking_sub_tutorial/README.md)
- [传感器数据订阅教程](https://github.com/stereolabs/zed-ros-examples/blob/master/tutorials/zed_sensors_sub_tutorial/README.md)
- [对象检测订阅教程](https://github.com/stereolabs/zed-ros-examples/blob/master/tutorials/zed_obj_det_sub_tutorial/README.md)

## 4.安装zed-ros-examples

依然是去对应的官网github上找对应的功能包[zed-ros-examples](https://github.com/stereolabs/zed-ros-examples)。

~~可以选择放在zed-ros-wrapper功能包下面，也可以选择自己另外建一个功能包，选择另外建需要source到含有ros-interface功能包的setup.bash。这里建议放在zed-ros-wrapper功能包下，只用source一次。~~

单独使用一个工作空间吧，省的报错。

```bash
cd ~/catkin_ws/src
git clone https://github.com/stereolabs/zed-ros-examples.git
cd ../
rosdep install --from-paths src --ignore-src -r -y
catkin_make -DCMAKE_BUILD_TYPE=Release
source ./devel/setup.bash
```

examples包依赖rviz的imu插件，一般是没装的，记得提前先装一下。

```bash
sudo apt-get install ros-melodic-rviz-imu-plugin
```

可能会遇到错误：

![26bd246f5976ac8fa3fe1bec23c89a9](安装软件包的操作笔记.assets/26bd246f5976ac8fa3fe1bec23c89a9.jpg)

CMake在编译`zed-ros-examples`包时找不到`zed_interfaces`包。这意味着`zed_interfaces`包要么没有安装，要么没有正确配置。首先我们肯定是安装了，但是这包不是全局的。所以得动source到当前bash窗口下。或者一劳永逸，加到全局变量里面：

```bash
export zed_interfaces_DIR=<path_to_zed_interfaces_package> # path_to_zed_interfaces_package为路径
```

最后launch命令可以在[Stereolabs ZED Camera - ROS Display package](https://github.com/stereolabs/zed-ros-examples/blob/master/zed_display_rviz/README.md)找到。

![image-20240717003105551](安装软件包的操作笔记.assets/image-20240717003105551.png)

这里我的相机是zed mini运行下面命令：

```bash
roslaunch zed_display_rviz display_zedm.launch
```

![b475d238723ce208d92f5d46ffdbb12](安装软件包的操作笔记.assets/b475d238723ce208d92f5d46ffdbb12.jpg)

![8ad01632c5ac6dd1f77f1c8ae12b2d2](安装软件包的操作笔记.assets/8ad01632c5ac6dd1f77f1c8ae12b2d2.jpg)